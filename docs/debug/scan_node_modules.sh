#!/bin/bash

echo "=== Scanning node_modules for suspicious indicators ==="
echo "Note: This is a heuristic scan. 'child_process' and 'install' scripts are common in legitimate packages."
echo "Look for obfuscated code, unexpected network calls, or strange binary files."
echo ""

echo "[1] Checking for 'install', 'preinstall', 'postinstall' scripts in package.json..."
# These scripts are the most common vector for supply chain attacks.
find node_modules -name "package.json" -type f -print0 | xargs -0 grep -H -E '"(pre|post)?install":' --color=always
echo ""

echo "[2] Checking for suspicious shell commands (curl, wget, powershell) in JS files..."
# Malware often downloads payloads using these tools.
find node_modules -name "*.js" -type f -print0 | xargs -0 grep -H -E "curl |wget |powershell|cmd\.exe|bash -c|sh -c" --color=always
echo ""

echo "[3] Checking for 'eval()' and 'child_process.exec' (potential RCE)..."
# eval() is rarely used in modern legitimate code.
find node_modules -name "*.js" -type f -print0 | xargs -0 grep -H -E "eval\(|child_process\.exec\(|child_process\.spawn\(" --color=always | head -n 20
echo "... (truncated output if too long)"
echo ""

echo "[4] Checking for suspicious file extensions (.exe, .dll, .sh, .bat)..."
# Pure JS packages usually shouldn't contain binaries unless they are wrappers.
find node_modules -type f \( -name "*.exe" -o -name "*.dll" -o -name "*.sh" -o -name "*.bat" \)
echo ""

echo "=== Scan Complete ==="
